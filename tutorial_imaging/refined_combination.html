
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Improving the image combination &#8212; pyemir-tutorials v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Spectroscopic mode tutorial: MOS data" href="../tutorial_mos/index.html" />
    <link rel="prev" title="Preliminary combination" href="preliminary_combination.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="improving-the-image-combination">
<h1>Improving the image combination<a class="headerlink" href="#improving-the-image-combination" title="Permalink to this headline">¶</a></h1>
<p>The image combination can be improve by tuning some of the parameters of the
recipe <code class="docutils literal notranslate"><span class="pre">FULL_DITHERED_IMAGE</span></code> (step 2 in the previous section).
In this sense, there is no need to repeat the basic reduction of the individual
exposures (step1).</p>
<p>As previously mentioned, two are the problems that we want to solve:</p>
<ol class="arabic simple">
<li><p><strong>Improve the offsets between individual exposures:</strong> this can be achieved
in several ways:</p>
<ul class="simple">
<li><p>by setting the requirement <code class="docutils literal notranslate"><span class="pre">refine_offsets:</span> <span class="pre">True</span></code>: in this case a
cross-correlation between subimage regions around bright targets is
carried out to derive refined offsets. See subsection
<a class="reference internal" href="#improving-offsets-1"><span class="std std-ref">Improving offsets (method #1)</span></a> below.</p></li>
<li><p>by providing an ASCII file with a list of offsets measured independently
by the user and indicated with the requirement <code class="docutils literal notranslate"><span class="pre">offsets:</span>
<span class="pre">user_offsets.txt</span></code>. See subsection <a class="reference internal" href="#improving-offsets-2"><span class="std std-ref">Improving offsets (method #2)</span></a> below.</p></li>
<li><p>by providing the same ASCII file with precomputed offsets (as in the
previous item) and using, in addition, the cross-correlation method. In
this case, both requirements <code class="docutils literal notranslate"><span class="pre">refine_offsets:</span> <span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">offsets:</span>
<span class="pre">user_offsets.txt</span></code> must be set. See subsection <a class="reference internal" href="#improving-offsets-3"><span class="std std-ref">Improving offsets (method #3)</span></a>
below.</p></li>
</ul>
</li>
<li><p><strong>Improve the sky background level estimation:</strong> the background level can be
improved by:</p>
<ul class="simple">
<li><p>generating an object mask and iterating the combination process. See
subsection <a class="reference internal" href="#improving-skybackground-1"><span class="std std-ref">Improving the sky background (problem #1)</span></a> below.</p></li>
<li><p>introducing an <em>ad hoc</em> fit to a low-order polynomial surface to the sky
background. See subsection <a class="reference internal" href="#improving-skybackground-2"><span class="std std-ref">Improving the sky background (problem #2)</span></a> below.</p></li>
</ul>
</li>
</ol>
<div class="section" id="improving-offsets-method-1">
<span id="improving-offsets-1"></span><h2>Improving offsets (method #1)<a class="headerlink" href="#improving-offsets-method-1" title="Permalink to this headline">¶</a></h2>
<p>We can activate the use of 2D cross-correlation of subimages around bright
targets to obtain refined offsets. This method works only if the initial
offsets (either derived from the WCS information in the image headers or from
an external file provided by the user) are a reasonable approximation to the
refined values. To activate this option it it necessary to set the requirement
<code class="docutils literal notranslate"><span class="pre">refine_offsets:</span> <span class="pre">True</span></code> in the observation result file.</p>
<p>This option is already set in line number 120 of the file <code class="docutils literal notranslate"><span class="pre">dithered_v1.yaml</span></code>,
available in the downloaded package for this tutorial.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>117
118
119
120
121</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
  <span class="n">iterations</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">sky_images</span><span class="p">:</span> <span class="mi">0</span>
<span class="hll">  <span class="n">refine_offsets</span><span class="p">:</span> <span class="kc">True</span>
</span><span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div>
<p>The refined version of the combined image is then obtained by executing numina
again with this new observation result file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run dithered_v1.yaml --link-files -r control.yaml
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/comparison_v1.gif"><img alt="combined image, version 1 compared with version 0" src="../_images/comparison_v1.gif" style="width: 100%;" /></a>
<a class="reference internal image-reference" href="../_images/comparison_v1_zoom.gif"><img alt="combined image, version 1 compared with version 0" src="../_images/comparison_v1_zoom.gif" style="width: 100%;" /></a>
</div>
<div class="section" id="improving-offsets-method-2">
<span id="improving-offsets-2"></span><h2>Improving offsets (method #2)<a class="headerlink" href="#improving-offsets-method-2" title="Permalink to this headline">¶</a></h2>
<p>An alternative to the use of the offsets computed from the WCS information in
the image header is to provide a two-column ASCII file with the measured
offsets between the individual images. The (arbitray) name of that file must be
provided through the requirement <code class="docutils literal notranslate"><span class="pre">offsets:</span></code>. For this tutoral, we are
providing such a file with the name <code class="docutils literal notranslate"><span class="pre">user_offsets.txt</span></code>. Note that this file
must be placed within the <code class="docutils literal notranslate"><span class="pre">data</span></code> subdirectory.</p>
<p>The observation result file <code class="docutils literal notranslate"><span class="pre">dithered_v2.yaml</span></code> is similar to the initial
<code class="docutils literal notranslate"><span class="pre">dithered_v0.yaml</span></code> file, with the inclusion of the new requirement (line
number 121):</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>117
118
119
120
121
122</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
  <span class="n">iterations</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">sky_images</span><span class="p">:</span> <span class="mi">0</span>
<span class="hll">  <span class="n">offsets</span><span class="p">:</span> <span class="n">user_offsets</span><span class="o">.</span><span class="n">txt</span>
</span>  <span class="n">refine_offsets</span><span class="p">:</span> <span class="kc">False</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div>
<p>The contents of the ASCII file with the measured offsets is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">emir</span><span class="p">)</span> <span class="n">cat</span> <span class="n">data</span><span class="o">/</span><span class="n">user_offsets</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">822</span> <span class="mi">907</span>
<span class="mi">730</span> <span class="mi">660</span>
<span class="mi">555</span> <span class="mi">863</span>
<span class="mi">620</span> <span class="mi">998</span>
<span class="mi">895</span> <span class="mi">741</span>
<span class="mi">545</span> <span class="mi">674</span>
<span class="mi">708</span> <span class="mi">811</span>
<span class="mi">830</span> <span class="mi">911</span>
<span class="mi">735</span> <span class="mi">666</span>
<span class="mi">561</span> <span class="mi">868</span>
<span class="mi">626</span> <span class="mi">1003</span>
<span class="mi">901</span> <span class="mi">746</span>
<span class="mi">551</span> <span class="mi">679</span>
<span class="mi">715</span> <span class="mi">816</span>
</pre></div>
</div>
<p>Execute numina to obtain the new version of the combined image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run dithered_v2.yaml --link-files -r control.yaml
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/comparison_v2.gif"><img alt="combined image, version 2 compared with version 0" src="../_images/comparison_v2.gif" style="width: 100%;" /></a>
<a class="reference internal image-reference" href="../_images/comparison_v2_zoom.gif"><img alt="combined image, version 2 compared with version 0" src="../_images/comparison_v2_zoom.gif" style="width: 100%;" /></a>
</div>
<div class="section" id="improving-offsets-method-3">
<span id="improving-offsets-3"></span><h2>Improving offsets (method #3)<a class="headerlink" href="#improving-offsets-method-3" title="Permalink to this headline">¶</a></h2>
<p>It is also possible to combine both the offsets provided by the user through an
external ASCII file, as well as the cross-correlation method to improve those
numbers.</p>
<p>The last lines of the new observation result file <code class="docutils literal notranslate"><span class="pre">dithered_v3.yaml</span></code> are the
following:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>117
118
119
120
121
122</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
  <span class="n">iterations</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">sky_images</span><span class="p">:</span> <span class="mi">0</span>
<span class="hll">  <span class="n">offsets</span><span class="p">:</span> <span class="n">user_offsets</span><span class="o">.</span><span class="n">txt</span>
</span><span class="hll">  <span class="n">refine_offsets</span><span class="p">:</span> <span class="kc">True</span>
</span><span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div>
<p>Execute numina again with this new observation result file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run dithered_v3.yaml --link-files -r control.yaml
</pre></div>
</div>
<p>The comparison with the result obtained by refining the offsets initially
computed from the WCS information indicates that both methods lead to basically
the same result.</p>
<a class="reference internal image-reference" href="../_images/comparison_v3.gif"><img alt="combined image, version 3 compared with version 1" src="../_images/comparison_v3.gif" style="width: 100%;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The conclusion of these comparisons is that the user can rely on the offsets
computed from the WCS information in the image headers as a
reasonable initial guess, but that these offsets need to be refined. Unless
something is really wrong with that WCS information, the user probabily will
not need to measure the offsets manually. Anyway, that option is always
there just in case it is necessary.</p>
</div>
</div>
<div class="section" id="improving-the-sky-background-problem-1">
<span id="improving-skybackground-1"></span><h2>Improving the sky background (problem #1)<a class="headerlink" href="#improving-the-sky-background-problem-1" title="Permalink to this headline">¶</a></h2>
<p>The first obvious way to improve the background computation is by masking the
objects present in the image. This masking process requires an initial object
detection, that must be carried out on the result of an initial combination.
For that reason, this masking requires to set <code class="docutils literal notranslate"><span class="pre">iterations</span></code> to a number larger
than zero.</p>
<p>In addition, the user can indicate that the sky signal at each pixel must be
computed from the signal at the same pixel in a predefined number of images
(close in observing time).</p>
<p>The observation result file <code class="docutils literal notranslate"><span class="pre">dithered_v4.yaml</span></code> includes both options:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>117
118
119
120
121</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
<span class="hll">  <span class="n">iterations</span><span class="p">:</span> <span class="mi">1</span>
</span><span class="hll">  <span class="n">sky_images</span><span class="p">:</span> <span class="mi">6</span>
</span>  <span class="n">refine_offsets</span><span class="p">:</span> <span class="kc">True</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">refine_offsets:</span> <span class="pre">True</span></code> is also being used, but without setting
<code class="docutils literal notranslate"><span class="pre">offsets</span></code> with an external ASCII file (i.e., the initial offsets will be
computed from the WCS information in the image headers).</p>
<p>Execute numina to start the reduction including object masking:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run dithered_v4.yaml --link-files -r control.yaml
</pre></div>
</div>
<p>It is useful to subtract the new result from the one derived previously:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina-imath obsid_combined_v1_results/result_image.fits - \
   obsid_combined_v4_results/result_image.fits difference_v4.fits
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/comparison_v4.gif"><img alt="combined image, version 4 compared with version 1" src="../_images/comparison_v4.gif" style="width: 100%;" /></a>
<a class="reference internal image-reference" href="../_images/comparison_v4_zoom.gif"><img alt="combined image, version 4 compared with version 1" src="../_images/comparison_v4_zoom.gif" style="width: 100%;" /></a>
</div>
<div class="section" id="improving-the-sky-background-problem-2">
<span id="improving-skybackground-2"></span><h2>Improving the sky background (problem #2)<a class="headerlink" href="#improving-the-sky-background-problem-2" title="Permalink to this headline">¶</a></h2>
<p>In all the previous examples, the combined images always exhibit variations in
the sky background that are clearly visible in the image borders. The reason
for that is that some individual exposures (in particular the first two
individual images), have a wrong image background.</p>
<p>The problem is more severe in the regions where the number of images used for
the combination is lower:</p>
<a class="reference internal image-reference" href="../_images/data_npix_v4.png"><img alt="combined data and number of pixels used in combination, version 4" src="../_images/data_npix_v4.png" style="width: 100%;" /></a>
<a class="reference internal image-reference" href="../_images/combined_v4_statistics.png"><img alt="combined data version 4, statistical analysis" src="../_images/combined_v4_statistics.png" style="width: 100%;" /></a>
<p>It is also possible to examine the sky-subtracted individual images (files
ending in <code class="docutils literal notranslate"><span class="pre">_rfs_i?.fits</span></code> within the <code class="docutils literal notranslate"><span class="pre">work</span></code> subdirectories):</p>
<a class="reference internal image-reference" href="../_images/skysub_v4.gif"><img alt="individual sky-subtracted images" src="../_images/skysub_v4.gif" style="width: 100%;" /></a>
<p>One possibility is to remove the first two images from the list of images to be
reduced. This is undesirable because it obviously reduces the depth of the
combined image.</p>
<p>Another option is to apply an <em>ad hoc</em> correction, by fitting for example a
low-order 2D polynomial surface to the masked (i.e. removing objects)
sky-subtracted images. This option can be activated by using the requirement
<code class="docutils literal notranslate"><span class="pre">nside_adhoc_sky_correction</span></code>. We have incorporated that option in the
observation result file <code class="docutils literal notranslate"><span class="pre">dithered_v5.yaml</span></code>, which also includes an iteration
to generate an object mask:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>117
118
119
120
121
122</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">requirements</span><span class="p">:</span>
  <span class="n">iterations</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">sky_images</span><span class="p">:</span> <span class="mi">6</span>
  <span class="n">refine_offsets</span><span class="p">:</span> <span class="kc">True</span>
<span class="hll">  <span class="n">nside_adhoc_sky_correction</span><span class="p">:</span> <span class="mi">10</span>
</span><span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div>
<p>Since the problem with the sky background in different for each quadrant of the
EMIR detector, the value of <code class="docutils literal notranslate"><span class="pre">nside_adhoc_sky_correction</span></code> indicates the
number subdivisions (in X and Y) in which each quadrant is subdivided. In this
case we are using a pattern of 10 x 10 regions in each quadrant. The median
value in each of these 100 subregions is computed (masking pixels affected by
objects) and a smooth spline surface is fitted to that collection of points.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run dithered_v5.yaml --link-files -r control.yaml
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/comparison_v5.gif"><img alt="combined image, version 5 compared with version 4" src="../_images/comparison_v5.gif" style="width: 100%;" /></a>
<a class="reference internal image-reference" href="../_images/combined_v5_statistics.png"><img alt="combined data version 5, statistical analysis" src="../_images/combined_v5_statistics.png" style="width: 100%;" /></a>
<p>In the last combination (v5) the sky background level is much flatter around
zero, except for those pixels in the combined image where only one single
exposure is available. By looking at the file <code class="docutils literal notranslate"><span class="pre">result_i1_npix.fits</span></code> it is
possible to check that those pixels are just at the borders of the combined
image.</p>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="preliminary_combination.html" title="Previous document">Preliminary combination</a>
        </li>
        <li>
          <a href="../tutorial_mos/index.html" title="Next document">Spectroscopic mode tutorial: MOS data</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preliminaries/preliminaries.html">Preliminaries</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Imaging mode tutorial: combination of dithered exposures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_mos/index.html">Spectroscopic mode tutorial: MOS data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_flat/index.html">Flatfield generation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Imaging mode tutorial: combination of dithered exposures</a><ul>
      <li>Previous: <a href="preliminary_combination.html" title="previous chapter">Preliminary combination</a></li>
      <li>Next: <a href="../tutorial_mos/index.html" title="next chapter">Spectroscopic mode tutorial: MOS data</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018-2020, Universidad Complutense de Madrid.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/tutorial_imaging/refined_combination.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>