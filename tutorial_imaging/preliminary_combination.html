
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preliminary combination &#8212; pyemir-tutorials v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Improving the image combination" href="refined_combination.html" />
    <link rel="prev" title="Imaging mode tutorial: combination of dithered exposures" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="preliminary-combination">
<h1>Preliminary combination<a class="headerlink" href="#preliminary-combination" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Before continuing, make sure that you have already initialize the file tree
structure by following the instructions provided in the
<a class="reference internal" href="../preliminaries/preliminaries.html#initial-file-tree"><span class="std std-ref">Initial file tree</span></a> section of this documentation.</p>
</div>
<p>Assume you want to combine the following raw images obtained using a dithered
pattern of 7 positions iterated twice (i.e., you have gathered a total of 14
images):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0001877553</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877559</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877565</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877571</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877577</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877583</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877589</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877595</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877601</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877607</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877613</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877619</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877625</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="mi">0001877631</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
</pre></div>
</div>
<p>Those files (together with some additional files that you will need to follow
this imaging example) are available as a compressed tgz file:
<a class="reference external" href="http://nartex.fis.ucm.es/data/pyemir/pyemir_imaging_tutorial_v3.tgz">pyemir_imaging_tutorial_v3.tgz</a>.</p>
<p>The preliminary combination of these 14 images will be carried out in two
steps:</p>
<ul class="simple">
<li><p><strong>Step 1:</strong> basic reduction of each individual image (bad-pixel masking and
flatfielding)</p></li>
<li><p><strong>Step 2:</strong> actual combination of the images</p></li>
</ul>
<div class="section" id="step-1-basic-reduction-of-individual-exposures">
<h2>Step 1: basic reduction of individual exposures<a class="headerlink" href="#step-1-basic-reduction-of-individual-exposures" title="Permalink to this headline">¶</a></h2>
<p>Move to the directory where you have deployed the initial file tree structure
containing the basic PyEmir calibration files (see  <a class="reference internal" href="../preliminaries/preliminaries.html#initial-file-tree"><span class="std std-ref">Initial file tree</span></a>).</p>
<p>Decompress there the previously mentioned tgz file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ tar zxvf pyemir_imaging_tutorial_v3.tgz
...
...
(emir) $ rm pyemir_imaging_tutorial_v3.tgz
</pre></div>
</div>
<p>This action should have populated the file tree with the
14 scientific raw FITS (placed wihtin the <code class="docutils literal notranslate"><span class="pre">data</span></code>
subdirectory) and some additional auxiliary files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ tree
.
├── control.yaml
├── data
│   ├── 0001877553-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877559-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877565-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877571-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877577-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877583-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877589-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877595-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877601-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877607-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877613-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877619-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877625-20181217-EMIR-STARE_IMAGE.fits
│   ├── 0001877631-20181217-EMIR-STARE_IMAGE.fits
│   ├── master_bpm.fits
│   ├── master_dark_zeros.fits
│   ├── master_flat_ones.fits
│   ├── master_flat_spec.fits
│   ├── rect_wpoly_MOSlibrary_grism_H_filter_H.json
│   ├── rect_wpoly_MOSlibrary_grism_J_filter_J.json
│   ├── rect_wpoly_MOSlibrary_grism_K_filter_Ksp.json
│   ├── rect_wpoly_MOSlibrary_grism_LR_filter_HK.json
│   ├── rect_wpoly_MOSlibrary_grism_LR_filter_YJ.json
│   └── user_offsets.txt
├── dithered_ini.yaml
├── dithered_v0.yaml
├── dithered_v1.yaml
├── dithered_v2.yaml
├── dithered_v3.yaml
├── dithered_v4.yaml
└── dithered_v5.yaml
</pre></div>
</div>
<p>You can easily examine the header of the scientific FITS images using the
astropy utility <code class="docutils literal notranslate"><span class="pre">fitsheader</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ fitsheader data/0001877*.fits -k obsblock -k imgobbl -k nimgobbl -k object -k exptime -k readmode -f
                   filename                    OBSBLOCK IMGOBBL NIMGOBBL OBJECT EXPTIME  READMODE
---------------------------------------------- -------- ------- -------- ------ -------- --------
data/0001877553-20181217-EMIR-STARE_IMAGE.fits        1       1        7   TEST 29.99926     RAMP
data/0001877559-20181217-EMIR-STARE_IMAGE.fits        1       2        7   TEST 29.99926     RAMP
data/0001877565-20181217-EMIR-STARE_IMAGE.fits        1       3        7   TEST 29.99926     RAMP
data/0001877571-20181217-EMIR-STARE_IMAGE.fits        1       4        7   TEST 29.99926     RAMP
data/0001877577-20181217-EMIR-STARE_IMAGE.fits        1       5        7   TEST 29.99926     RAMP
data/0001877583-20181217-EMIR-STARE_IMAGE.fits        1       6        7   TEST 29.99926     RAMP
data/0001877589-20181217-EMIR-STARE_IMAGE.fits        1       7        7   TEST 29.99926     RAMP
data/0001877595-20181217-EMIR-STARE_IMAGE.fits        2       1        7   TEST 29.99926     RAMP
data/0001877601-20181217-EMIR-STARE_IMAGE.fits        2       2        7   TEST 29.99926     RAMP
data/0001877607-20181217-EMIR-STARE_IMAGE.fits        2       3        7   TEST 29.99926     RAMP
data/0001877613-20181217-EMIR-STARE_IMAGE.fits        2       4        7   TEST 29.99926     RAMP
data/0001877619-20181217-EMIR-STARE_IMAGE.fits        2       5        7   TEST 29.99926     RAMP
data/0001877625-20181217-EMIR-STARE_IMAGE.fits        2       6        7   TEST 29.99926     RAMP
data/0001877631-20181217-EMIR-STARE_IMAGE.fits        2       7        7   TEST 29.99926     RAMP
</pre></div>
</div>
<p>Note that:</p>
<ul class="simple">
<li><p>the keyword <code class="docutils literal notranslate"><span class="pre">OBSBLOCK</span></code> gives the observing block number.</p></li>
<li><p>the keyword <code class="docutils literal notranslate"><span class="pre">NIMGOBBL</span></code> provides the total number of images in each
dithering pattern (7 in this case).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IMGOBBL</span></code> indicates the sequential number within each pattern.</p></li>
</ul>
<p>The first step in the reduction process will be the bad-pixel mask
and flatfield corrections.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember that the <code class="docutils literal notranslate"><span class="pre">numina</span></code> script is the interface with GTC pipelines.
In order to execute PyEmir recipes you should use type something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run &lt;observation_result_file.yaml&gt; -r &lt;requirements_file.yaml&gt;
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;observation_result_file.yaml&gt;</span></code> is an observation result file in
YAML format, and <code class="docutils literal notranslate"><span class="pre">&lt;requirements_files.yaml&gt;</span></code> is a requirements file, also
in YAML format.</p>
<p>YAML is a human-readable data serialization language (for details see
<a class="reference external" href="https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html">YAML Syntax</a>)</p>
</div>
<p>The deployed file tree already contains the files required
to execute the initial reduction recipe needed in this case: the observation
result file <code class="docutils literal notranslate"><span class="pre">dithered_ini.yaml</span></code> and the requirements file <code class="docutils literal notranslate"><span class="pre">control.yaml</span></code>.
Let’s have a look to each of them separately.</p>
<p><strong>The observation result file:</strong> <code class="docutils literal notranslate"><span class="pre">dithered_ini.yaml</span></code></p>
<p>This is what we call an observation result file, which basically contains the
reduction recipes to be applied and the images involved. Note that this
particular file contains 14 blocks, one for each individual image.</p>
<p>Each block is separated by a line containing just three dashes (<code class="docutils literal notranslate"><span class="pre">---</span></code>):</p>
<ul class="simple">
<li><p>Do not forget the separation line <code class="docutils literal notranslate"><span class="pre">---</span></code> between blocks (otherwise the
pipeline will not recognize where one block ends and the next one begins).</p></li>
<li><p>This separation line must not appear after the last block.</p></li>
</ul>
<p>The contents of this file is displayed below,
highlighting the first block (first six lines):</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nb">id</span><span class="p">:</span> <span class="n">_0001877553</span>
</span><span class="hll"><span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
</span><span class="hll"><span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
</span><span class="hll"><span class="n">frames</span><span class="p">:</span>
</span><span class="hll"> <span class="o">-</span> <span class="mi">0001877553</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
</span><span class="hll"><span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
</span><span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877559</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877559</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877565</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877565</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877571</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877571</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877577</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877577</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877583</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877583</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877589</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877589</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877595</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877595</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877601</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877601</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877607</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877607</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877613</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877613</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877619</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877619</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877625</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877625</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877631</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877631</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">id</span></code> value is an arbitrary label that is employed to generate the name
of two auxiliary subdirectories. In this example the reduction of the first
block will generate two subdirectories named <code class="docutils literal notranslate"><span class="pre">obsid_0001877553_work</span></code> and
<code class="docutils literal notranslate"><span class="pre">obsid_0001877553_results</span></code>, where the intermediate results and the final
results are going to be stored, respectively. Note that we have arbitrarily
chosen the 10 digits of the unique running number assigned to each image
obtained with the GTC to build the label.</p></li>
<li><p>Not surprisingly, the key <code class="docutils literal notranslate"><span class="pre">instrument</span></code> is set to EMIR (do not forget that
Numina also is at present also employed to reduce MEGARA data, and hopefully,
future GTC instruments).</p></li>
<li><p>The key <code class="docutils literal notranslate"><span class="pre">mode</span></code> indicates the identification of the reduction recipe
(<code class="docutils literal notranslate"><span class="pre">STARE_IMAGE</span></code> in this example).</p></li>
<li><p>The key <code class="docutils literal notranslate"><span class="pre">frames</span></code> lists the images to be combined prior to the execution of
the reduction recipe. In this case a single image has been obtained at each
point of the dithering pattern before moving to the next location within the
pattern. For that reason a single image appears in each block.</p></li>
<li><p>The key <code class="docutils literal notranslate"><span class="pre">enabled:</span> <span class="pre">True</span></code> indicates that this block is going to be reduced.
As it is going to be shown later, the user can easily
activate/deactivate the execution of particular reduction recipes (i.e.
blocks in this file) just by modifying this flag.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Since the generation of the file <code class="docutils literal notranslate"><span class="pre">dithered_ini.yaml</span></code> can be cumbersome,
specially
when the number of images is large, an auxiliary script has been
incorporated in PyEmir in order to help in its generation.</p>
<p>In particular, the file used in this example can be easily created using a
few simple commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ cd data/
(emir) $ ls 0001877*fits &gt; list_images.txt
(emir) $ cd ..
(emir) $ pyemir-generate_yaml_for_dithered_image \
  data/list_images.txt --step 0 --outfile dithered_ini.yaml
</pre></div>
</div>
<p>Note that a temporary file <code class="docutils literal notranslate"><span class="pre">list_images.txt</span></code> is created with a list of the
the individual exposures.  The script
<code class="docutils literal notranslate"><span class="pre">pyemir-generate_yaml_for_dithered_image</span></code> reads that file and generate the
observation result file <code class="docutils literal notranslate"><span class="pre">dithered_ini.yaml</span></code> (the parameter <code class="docutils literal notranslate"><span class="pre">--step</span> <span class="pre">0</span></code>
indicates that the reduction recipe to be used here is <code class="docutils literal notranslate"><span class="pre">STARE_IMAGE</span></code>,
which corresponds to the preliminary image reduction).</p>
</div>
<p><strong>The requirements file:</strong> <code class="docutils literal notranslate"><span class="pre">control.yaml</span></code></p>
<p>This is the requirements file, containing the expected name of generic
calibration files. You do not need to modify anything here.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">products</span><span class="p">:</span>
  <span class="n">EMIR</span><span class="p">:</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterBadPixelMask&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;master_bpm.fits&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterDark&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;master_dark_zeros.fits&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterIntensityFlat&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;master_flat_spec.fits&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterSpectralFlat&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;master_flat_spec.fits&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterRectWave&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">J</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">J</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;rect_wpoly_MOSlibrary_grism_J_filter_J.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterRectWave&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">H</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;rect_wpoly_MOSlibrary_grism_H_filter_H.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterRectWave&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">Ksp</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;rect_wpoly_MOSlibrary_grism_K_filter_Ksp.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterRectWave&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">LR</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">YJ</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;rect_wpoly_MOSlibrary_grism_LR_filter_YJ.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;MasterRectWave&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">LR</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">HK</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;rect_wpoly_MOSlibrary_grism_LR_filter_HK.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;RefinedBoundaryModelParam&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">J</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">J</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;final_multislit_bound_param_grism_J_filter_J.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;RefinedBoundaryModelParam&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">H</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;final_multislit_bound_param_grism_H_filter_H.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;RefinedBoundaryModelParam&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">Ksp</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;final_multislit_bound_param_grism_K_filter_Ksp.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;RefinedBoundaryModelParam&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">LR</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">YJ</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;final_multislit_bound_param_grism_LR_filter_YJ.json&#39;</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;RefinedBoundaryModelParam&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{</span><span class="n">grism</span><span class="p">:</span> <span class="n">LR</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">HK</span><span class="p">},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;final_multislit_bound_param_grism_LR_filter_HK.json&#39;</span><span class="p">}</span>
<span class="n">requirements</span><span class="p">:</span>
  <span class="n">EMIR</span><span class="p">:</span>
    <span class="n">default</span><span class="p">:</span>
     <span class="n">FULL_DITHERED_IMAGE</span><span class="p">:</span>
      <span class="o">-</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;x_offsets&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="p">{},</span> <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;ref_object_pos.txt&#39;</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Numina execution</strong></p>
<p>You are ready to execute the reduction recipe indicated in the file
<code class="docutils literal notranslate"><span class="pre">dithered_ini.yaml</span></code> (in this case the reduccion recipe named
<code class="docutils literal notranslate"><span class="pre">STARE_IMAGE</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run dithered_ini.yaml -r control.yaml
...
...
</pre></div>
</div>
<p>After the execution of the previous command line, two subdirectories for each
block should have appeared:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ ls
control.yaml              obsid_0001877565_results/ obsid_0001877601_work/
data/                     obsid_0001877565_work/    obsid_0001877607_results/
dithered_ini.yaml         obsid_0001877571_results/ obsid_0001877607_work/
dithered_v0.yaml          obsid_0001877571_work/    obsid_0001877613_results/
dithered_v1.yaml          obsid_0001877577_results/ obsid_0001877613_work/
dithered_v2.yaml          obsid_0001877577_work/    obsid_0001877619_results/
dithered_v3.yaml          obsid_0001877583_results/ obsid_0001877619_work/
dithered_v4.yaml          obsid_0001877583_work/    obsid_0001877625_results/
dithered_v5.yaml          obsid_0001877589_results/ obsid_0001877625_work/
obsid_0001877553_results/ obsid_0001877589_work/    obsid_0001877631_results/
obsid_0001877553_work/    obsid_0001877595_results/ obsid_0001877631_work/
obsid_0001877559_results/ obsid_0001877595_work/
obsid_0001877559_work/    obsid_0001877601_results/
</pre></div>
</div>
<p><strong>The</strong> <code class="docutils literal notranslate"><span class="pre">work</span></code> <strong>subdirectories</strong></p>
<p>All the relevant images (scientific and calibrations) involved in the reduction
of a particular block of the observation result file are copied into the
<code class="docutils literal notranslate"><span class="pre">work</span></code> subdirectories in order to preserve the original files.</p>
<p>In particular, for the first block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ tree obsid_0001877553_work/
obsid_0001877553_work/
├── 0001877553-20181217-EMIR-STARE_IMAGE.fits
├── index.pkl
├── mask_bpm.fits
├── master_dark_zeros.fits
└── master_flatframe.fits
</pre></div>
</div>
<p><em>When disk space is an issue, it is possible to execute numina indicating that
links (instead of actual copies of the original raw files) must be placed in the
``work`` subdirectory.</em> This behaviour is set using the parameter
<code class="docutils literal notranslate"><span class="pre">--link-files</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run dithered_ini.yaml --link-files -r control.yaml
...
...

(emir) $ tree obsid_0001877553_work/
obsid_0001877553_work/
├── 0001877553-20181217-EMIR-STARE_IMAGE.fits -&gt; /Users/cardiel/w/GTC/emir/work/z_tutorials_201907/x/data/0001877553-20181217-EMIR-STARE_IMAGE.fits
├── index.pkl
├── master_bpm.fits -&gt; /Users/cardiel/w/GTC/emir/work/z_tutorials_201907/x/data/master_bpm.fits
├── master_dark_zeros.fits -&gt; /Users/cardiel/w/GTC/emir/work/z_tutorials_201907/x/data/master_dark_zeros.fits
└── master_flat_spec.fits -&gt; /Users/cardiel/w/GTC/emir/work/z_tutorials_201907/x/data/master_flat_spec.fits
</pre></div>
</div>
<p><strong>The</strong> <code class="docutils literal notranslate"><span class="pre">results</span></code> <strong>subdirectories</strong></p>
<p>These subdirectories store the result of the execution of the reduction
recipes. In particular, for the first block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tree obsid_0001877553_results/
obsid_0001877553_results/
├── processing.log
├── result.json
├── result_image.fits
└── task.json
</pre></div>
</div>
<p>Note that although all the reduced images receive the same name in all these
<code class="docutils literal notranslate"><span class="pre">results</span></code> subdirectories (for this reduction recipe <code class="docutils literal notranslate"><span class="pre">result_image.fits</span></code>),
there is no confusion because the subdirectory name contains a unique label for
each block in the observation result file.</p>
</div>
<div class="section" id="step-2-image-combination">
<h2>Step 2: image combination<a class="headerlink" href="#step-2-image-combination" title="Permalink to this headline">¶</a></h2>
<p>After the basic reduction performed in step 1, we can proceed with the
combination of the images. For that purpose a different reduction recipe must
be employed: <code class="docutils literal notranslate"><span class="pre">FULL_DITHERED_IMAGE</span></code>.</p>
<p>This task is carried out using a new
observation result file: <code class="docutils literal notranslate"><span class="pre">dithered_v0.yaml</span></code>: the first 97 lines of this new
file are the same as the content of the the previous file
<code class="docutils literal notranslate"><span class="pre">dithered_ini.yaml</span></code>, but setting <code class="docutils literal notranslate"><span class="pre">enabled:</span> <span class="pre">False</span></code> in each of the 14 blocks.
This flag indicates that the execution of the recipe <code class="docutils literal notranslate"><span class="pre">STARE_IMAGE</span></code> is no
longer necessary in any of the 14 blocks. <strong>Note however that these blocks must
explicitly appear in the observation result file, even though they imply no
actual reduction, because they define the location of the previously reduced
images</strong>.</p>
<p>The new observation result file <code class="docutils literal notranslate"><span class="pre">dithered_v0.yaml</span></code> contains a new block at
the end (see lines 99-121 below), that is responsible of the execution of the
combination of the previously reduced images:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="p">:</span> <span class="n">_0001877553</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877553</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877559</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877559</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877565</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877565</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877571</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877571</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877577</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877577</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877583</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877583</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877589</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877589</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877595</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877595</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877601</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877601</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877607</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877607</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877613</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877613</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877619</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877619</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877625</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877625</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="nb">id</span><span class="p">:</span> <span class="n">_0001877631</span>
<span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
<span class="n">mode</span><span class="p">:</span> <span class="n">STARE_IMAGE</span>
<span class="n">frames</span><span class="p">:</span>
 <span class="o">-</span> <span class="mi">0001877631</span><span class="o">-</span><span class="mi">20181217</span><span class="o">-</span><span class="n">EMIR</span><span class="o">-</span><span class="n">STARE_IMAGE</span><span class="o">.</span><span class="n">fits</span>
<span class="n">enabled</span><span class="p">:</span> <span class="kc">False</span>
<span class="o">---</span>
<span class="hll"><span class="nb">id</span><span class="p">:</span> <span class="n">_combined_v0</span>
</span><span class="hll"><span class="n">instrument</span><span class="p">:</span> <span class="n">EMIR</span>
</span><span class="hll"><span class="n">mode</span><span class="p">:</span> <span class="n">FULL_DITHERED_IMAGE</span>
</span><span class="hll"><span class="n">children</span><span class="p">:</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877553</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877559</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877565</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877571</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877577</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877583</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877589</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877595</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877601</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877607</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877613</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877619</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877625</span>
</span><span class="hll"> <span class="o">-</span> <span class="n">_0001877631</span>
</span><span class="hll"><span class="n">requirements</span><span class="p">:</span>
</span><span class="hll">  <span class="n">iterations</span><span class="p">:</span> <span class="mi">0</span>
</span><span class="hll">  <span class="n">sky_images</span><span class="p">:</span> <span class="mi">0</span>
</span><span class="hll">  <span class="n">refine_offsets</span><span class="p">:</span> <span class="kc">False</span>
</span><span class="hll"><span class="n">enabled</span><span class="p">:</span> <span class="kc">True</span>
</span></pre></div>
</td></tr></table></div>
<p>The new block (lines 99-121) indicates that the reduction recipe
<code class="docutils literal notranslate"><span class="pre">FULL_DITHERED_IMAGE</span></code> must be executed using as input the results of the
previous blocks. In particular, the <code class="docutils literal notranslate"><span class="pre">id's</span></code> of the initial 14 blocks are given
under the <code class="docutils literal notranslate"><span class="pre">children:</span></code> keyword (lines 103 to 116).</p>
<p>In addition, a few parameters (which will be modified later) are set to some
default values in this initial combination:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">iterations:</span> <span class="pre">0</span></code>: this parameter indicates whether an object mask is
employed or not. A value of <code class="docutils literal notranslate"><span class="pre">0</span></code> means that no object mask is computed. Note
that an object mask allows a better sky background determination since bright
objects are removed prior to the sky signal estimation. When this parameter
is greater than zero, an object mask is created by performing a
SEXtractor-like object search in the resulting image at the end of the
previous iteration.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sky_images:</span> <span class="pre">0</span></code>: number of images employed to determine the sky background
of each pixel. Setting this parameter to <code class="docutils literal notranslate"><span class="pre">0</span></code> indicates that the sky
background is simply computed as the median value in the same image in which
the pixel background is being estimated. Using a value larger than zero sets
the number of closest images (in time) where the signal of a particular pixel
is averaged (for example, a value of <code class="docutils literal notranslate"><span class="pre">6</span></code> will tipically mean that the sky
background will be estimated using 3 images acquired before and 3 images
acquired after the current one; note that at the beginning and at the end of
a given observation sequence, the closest nearby images correspond to
exposures obtained only after or only before the current one, respectively).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refine_offsets:</span> <span class="pre">False</span></code>: this flag indicates whether the offsets between
images must be refined using cross-correlation of subimages around the
brightest objects.</p></li>
</ul>
<p>As it will be explained later, the use of these parameters can help to obtain
better results. So far we are only interested in showing a fast way to generate
a combined image.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The file <code class="docutils literal notranslate"><span class="pre">dithered_v0.yaml</span></code> can also be automatically generated using
the same script previously mentioned in step 1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ pyemir-generate_yaml_for_dithered_image \
  data/list_images.txt --step 1 --obsid_combined combined_v0 \
  --outfile dithered_v0.yaml
</pre></div>
</div>
<p>Note that here we are using <code class="docutils literal notranslate"><span class="pre">--step</span> <span class="pre">1</span></code> instead of <code class="docutils literal notranslate"><span class="pre">--step</span> <span class="pre">0</span></code>. In
addition, a new parameter <code class="docutils literal notranslate"><span class="pre">--obsid_combined</span> <span class="pre">combined_v0</span></code> has also been
employed in order to set the <code class="docutils literal notranslate"><span class="pre">id</span></code> of the block responsible for the
execution of the combination recipe (see line number 99 above).</p>
</div>
<p>The combination of the images is finally performed using numina:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina run dithered_v0.yaml --link-files -r control.yaml
</pre></div>
</div>
<p>The previous execution also generates two auxiliary subdirectories <code class="docutils literal notranslate"><span class="pre">work</span></code> and
<code class="docutils literal notranslate"><span class="pre">results</span></code>. The resulting combined image can be found in
<code class="docutils literal notranslate"><span class="pre">obsid_combined_v0_result/result_image.fits</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ tree obsid_combined_v0_results/
obsid_combined_v0_results/
├── processing.log
├── result.json
├── result_image.fits
└── task.json
</pre></div>
</div>
<p>You can display the image using <code class="docutils literal notranslate"><span class="pre">ds9</span></code>, using <code class="docutils literal notranslate"><span class="pre">numina-ximshow</span></code> (the display
tool shipped with numina based on matplotlib), or with any other tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(emir) $ numina-ximshow obsid_combined_v0_results/result_image.fits
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/combined_v0_trimmed.png"><img alt="combined image, version 0" src="../_images/combined_v0_trimmed.png" style="width: 100%;" /></a>
<p>It is clear that this combined image is far from perfect. In particular, there
are inhomogeneities in the background level, which are easier to see at the
image borders. In addition, the objects appear elongated, which indicates that
the offsets between individual exposures, determined from the WCS header
information, are not suficiently precise. The zoomed region shown in the next
image reveals that the problem is not negligible:</p>
<a class="reference internal image-reference" href="../_images/combined_v0_zoom_trimmed.png"><img alt="combined image, version 0" src="../_images/combined_v0_zoom_trimmed.png" style="width: 100%;" /></a>
<p>In the next section we are showing several alternatives to improve the
image combination.</p>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="index.html" title="Previous document">Imaging mode tutorial: combination of dithered exposures</a>
        </li>
        <li>
          <a href="refined_combination.html" title="Next document">Improving the image combination</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preliminaries/preliminaries.html">Preliminaries</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Imaging mode tutorial: combination of dithered exposures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_mos/index.html">Spectroscopic mode tutorial: MOS data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_flat/index.html">Flatfield generation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Imaging mode tutorial: combination of dithered exposures</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Imaging mode tutorial: combination of dithered exposures</a></li>
      <li>Next: <a href="refined_combination.html" title="next chapter">Improving the image combination</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018-2020, Universidad Complutense de Madrid.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/tutorial_imaging/preliminary_combination.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>